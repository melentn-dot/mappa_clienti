<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa Clienti</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; display: flex; height: 100vh; }
        .sidebar { width: 380px; background: white; box-shadow: 2px 0 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .header { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; padding: 20px; }
        .header h2 { margin: 0; font-size: 20px; }
        .header p { margin: 5px 0 0 0; font-size: 13px; opacity: 0.9; }
        .upload-area { padding: 20px; text-align: center; border-bottom: 1px solid #e5e7eb; }
        .upload-btn { background: #2563eb; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; }
        .upload-btn:hover { background: #1d4ed8; transform: translateY(-1px); }
        .upload-btn:disabled { background: #9ca3af; cursor: not-allowed; transform: none; }
        .filters { padding: 15px 20px; border-bottom: 1px solid #e5e7eb; display: none; background: #f9fafb; }
        .filters.active { display: block; }
        .filter-group { margin-bottom: 12px; }
        .filter-group:last-child { margin-bottom: 0; }
        .filter-group label { display: block; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 6px; }
        .filters select, .filters input { width: 100%; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; font-size: 13px; }
        .filters select:focus, .filters input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .stats { padding: 12px 20px; background: #eff6ff; border-bottom: 1px solid #e5e7eb; font-size: 12px; color: #1e40af; }
        .stats-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .stat-item { display: flex; align-items: center; gap: 6px; }
        .stat-dot { width: 10px; height: 10px; border-radius: 50%; }
        .dot-primary { background: #2563eb; }
        .dot-secondary { background: #f97316; }
        .progress-bar { background: #dbeafe; border-radius: 6px; padding: 10px; margin-top: 10px; }
        .progress-text { font-size: 11px; color: #1e40af; margin-bottom: 6px; }
        .progress-fill { height: 4px; background: #2563eb; border-radius: 2px; transition: width 0.3s; }
        .customer-list { flex: 1; overflow-y: auto; padding: 15px; }
        .customer-card { background: white; padding: 12px; margin-bottom: 10px; border-radius: 8px; font-size: 13px; border: 1px solid #e5e7eb; transition: all 0.2s; }
        .customer-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .customer-card.secondary { background: #fff7ed; border-color: #fdba74; }
        .customer-name { font-weight: 700; margin-bottom: 6px; color: #111827; font-size: 14px; }
        .customer-badge { display: inline-block; background: #fed7aa; color: #9a3412; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; margin-bottom: 6px; }
        .customer-info { margin: 4px 0; color: #6b7280; line-height: 1.5; }
        .customer-info a { color: #2563eb; text-decoration: none; }
        .customer-info a:hover { text-decoration: underline; }
        .customer-category { font-size: 11px; color: #6b7280; margin-top: 6px; padding-top: 6px; border-top: 1px solid #e5e7eb; }
        .info-box { padding: 15px; margin: 15px 20px; background: #dbeafe; border: 1px solid #60a5fa; border-radius: 6px; font-size: 12px; color: #1e40af; }
        .info-title { font-weight: 700; margin-bottom: 4px; }
        #map { flex: 1; }
        .loading { display: inline-block; width: 12px; height: 12px; border: 2px solid #2563eb; border-top-color: transparent; border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Personalizzazione cluster */
        .marker-cluster-small { background-color: rgba(37, 99, 235, 0.6); }
        .marker-cluster-small div { background-color: rgba(37, 99, 235, 0.8); color: white; font-weight: bold; }
        .marker-cluster-medium { background-color: rgba(249, 115, 22, 0.6); }
        .marker-cluster-medium div { background-color: rgba(249, 115, 22, 0.8); color: white; font-weight: bold; }
        .marker-cluster-large { background-color: rgba(220, 38, 38, 0.6); }
        .marker-cluster-large div { background-color: rgba(220, 38, 38, 0.8); color: white; font-weight: bold; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="header">
            <h2>üèóÔ∏è Mappa Clienti</h2>
            <p>Distribuzione Materiali Edilizia</p>
        </div>
        
        <div class="upload-area">
            <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none">
            <button class="upload-btn" id="uploadBtn" onclick="document.getElementById('fileInput').click()">
                üìÅ Carica Excel Clienti
            </button>
        </div>

        <div class="filters" id="filters">
            <div class="filter-group">
                <label>üîç Filtra per provincia</label>
                <select id="provinceFilter">
                    <option value="">-- Tutte le province --</option>
                </select>
            </div>
            <div class="filter-group">
                <label>üîé Cerca cliente</label>
                <input type="text" id="searchInput" placeholder="Nome, citt√†, categoria...">
            </div>
        </div>

        <div class="stats" id="statsSection" style="display:none;"></div>

        <div id="infoBox"></div>

        <div class="customer-list" id="customerList"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let map = L.map('map').setView([45.4642, 9.19], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);
        
        let customers = [];
        let markerClusterGroup = L.markerClusterGroup({
            chunkedLoading: true,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
            maxClusterRadius: 80
        });
        map.addLayer(markerClusterGroup);
        
        let isGeocoding = false;

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const btn = document.getElementById('uploadBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Caricamento...';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                    const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    processData(rows);
                    btn.innerHTML = '‚úì File caricato';
                    setTimeout(() => {
                        btn.innerHTML = 'üìÅ Carica altro Excel';
                        btn.disabled = false;
                    }, 2000);
                } catch(err) {
                    alert('Errore nel caricamento: ' + err.message);
                    btn.innerHTML = 'üìÅ Carica Excel Clienti';
                    btn.disabled = false;
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function processData(rows) {
            customers = [];
            const provinces = new Set();
            
            rows.forEach(row => {
                if (row['Indirizzo'] && row['Localita']) {
                    const prov = (row['Localita'].match(/\(([A-Z]{2})\)/) || [])[1] || '';
                    if (prov) provinces.add(prov);
                    
                    customers.push({
                        name: row['Nome Cliente'] || '',
                        address: row['Indirizzo'] + ', ' + row['Localita'] + ', Italy',
                        fullAddress: row['Indirizzo'] || '',
                        city: row['Localita'] || '',
                        email: row['Email'] || '',
                        phone: row['Telefono'] || '',
                        mobile: row['Cellulare'] || '',
                        category: row['CategCommerciale'] || '',
                        agent: row['Agente'] || '',
                        partitaIVA: row['PartitaIVA'] || '',
                        province: prov,
                        type: 'primary'
                    });
                }

                if (row['Indirizzo Secondario di consegna'] && row['Localita Indirizzo Secondario di consegna']) {
                    const prov = (row['Localita Indirizzo Secondario di consegna'].match(/\(([A-Z]{2})\)/) || [])[1] || '';
                    if (prov) provinces.add(prov);
                    
                    customers.push({
                        name: row['Nome Cliente'] || '',
                        address: row['Indirizzo Secondario di consegna'] + ', ' + row['Localita Indirizzo Secondario di consegna'] + ', Italy',
                        fullAddress: row['Indirizzo Secondario di consegna'] || '',
                        city: row['Localita Indirizzo Secondario di consegna'] || '',
                        email: row['Email'] || '',
                        phone: row['Telefono'] || '',
                        mobile: row['Cellulare'] || '',
                        category: row['CategCommerciale'] || '',
                        agent: row['Agente'] || '',
                        partitaIVA: row['PartitaIVA'] || '',
                        descSede: row['DescSede'] || '',
                        province: prov,
                        type: 'secondary'
                    });
                }
            });

            // Popola filtro province
            const select = document.getElementById('provinceFilter');
            select.innerHTML = '<option value="">-- Tutte le province --</option>';
            Array.from(provinces).sort().forEach(p => {
                const count = customers.filter(c => c.province === p).length;
                const opt = document.createElement('option');
                opt.value = p;
                opt.textContent = `${p} (${count} clienti)`;
                select.appendChild(opt);
            });

            document.getElementById('filters').classList.add('active');
            
            document.getElementById('infoBox').innerHTML = `
                <div class="info-box">
                    <div class="info-title">‚ÑπÔ∏è ${customers.length} clienti caricati</div>
                    Seleziona una provincia per visualizzare i marker sulla mappa. I marker sono raggruppati in cluster: fai zoom per vedere i dettagli!
                </div>
            `;
            
            showCustomers(customers);
            updateStats(customers);
        }

        function updateStats(list) {
            const primary = list.filter(c => c.type === 'primary').length;
            const secondary = list.filter(c => c.type === 'secondary').length;
            
            const statsSection = document.getElementById('statsSection');
            statsSection.style.display = 'block';
            statsSection.innerHTML = `
                <div class="stats-row">
                    <div class="stat-item">
                        <div class="stat-dot dot-primary"></div>
                        <span>Principale: ${primary}</span>
                    </div>
                    <div class="stat-item">
                        <div class="stat-dot dot-secondary"></div>
                        <span>Secondario: ${secondary}</span>
                    </div>
                    <div class="stat-item">
                        <span>üìç Totale: ${list.length}</span>
                    </div>
                </div>
            `;
        }

        function showCustomers(list) {
            const container = document.getElementById('customerList');
            container.innerHTML = list.slice(0, 200).map(c => `
                <div class="customer-card ${c.type}">
                    <div class="customer-name">${c.name}</div>
                    ${c.type === 'secondary' ? '<div class="customer-badge">üìç Indirizzo Secondario' + (c.descSede ? ' - ' + c.descSede : '') + '</div>' : ''}
                    <div class="customer-info">üìç ${c.fullAddress}</div>
                    <div class="customer-info">${c.city}</div>
                    ${c.email ? '<div class="customer-info"><a href="mailto:' + c.email + '">‚úâÔ∏è ' + c.email + '</a></div>' : ''}
                    ${c.phone ? '<div class="customer-info"><a href="tel:' + c.phone + '">üìû ' + c.phone + '</a></div>' : ''}
                    ${c.mobile ? '<div class="customer-info"><a href="tel:' + c.mobile + '">üì± ' + c.mobile + '</a></div>' : ''}
                    ${c.category || c.agent ? '<div class="customer-category">' + 
                        (c.category ? c.category : '') + 
                        (c.category && c.agent ? ' ‚Ä¢ ' : '') + 
                        (c.agent ? c.agent : '') + 
                    '</div>' : ''}
                </div>
            `).join('');
            
            if (list.length > 200) {
                container.innerHTML += '<div style="padding: 15px; text-align: center; color: #6b7280; font-size: 12px;">Mostrando i primi 200 di ' + list.length + ' clienti</div>';
            }
        }

        async function geocodeAll(list) {
            if (isGeocoding) return;
            isGeocoding = true;
            
            markerClusterGroup.clearLayers();

            const statsSection = document.getElementById('statsSection');
            const progressDiv = document.createElement('div');
            progressDiv.className = 'progress-bar';
            progressDiv.innerHTML = `
                <div class="progress-text">Caricamento marker: <span id="progressText">0 / ${list.length}</span></div>
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            `;
            statsSection.appendChild(progressDiv);

            let loaded = 0;

            // Geocodifica 5 alla volta per velocit√†
            for (let i = 0; i < list.length; i += 5) {
                const batch = list.slice(i, i + 5);
                
                await Promise.all(batch.map(async (c) => {
                    try {
                        const res = await fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(c.address) + '&limit=1', {
                            headers: { 'User-Agent': 'CustomerMapApp' }
                        });
                        const data = await res.json();
                        
                        if (data[0]) {
                            const marker = L.marker([data[0].lat, data[0].lon], {
                                icon: L.divIcon({
                                    html: '<div style="background:' + (c.type === 'primary' ? '#2563eb' : '#f97316') + ';width:12px;height:12px;border-radius:50%;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3)"></div>',
                                    iconSize: [12, 12],
                                    iconAnchor: [6, 6]
                                })
                            });
                            
                            marker.bindPopup(`
                                <div style="font-family: system-ui; min-width: 250px;">
                                    ${c.type === 'secondary' ? '<div style="background: #fed7aa; color: #9a3412; padding: 4px 8px; border-radius: 4px; margin-bottom: 8px; font-size: 11px; font-weight: 600;">üìç INDIRIZZO SECONDARIO' + (c.descSede ? ' - ' + c.descSede : '') + '</div>' : ''}
                                    <div style="font-weight: 700; font-size: 14px; margin-bottom: 6px;">${c.name}</div>
                                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">üìç ${c.fullAddress}<br>${c.city}</div>
                                    ${c.email ? '<div style="font-size: 12px; margin: 3px 0;"><a href="mailto:' + c.email + '" style="color: #2563eb; text-decoration: none;">‚úâÔ∏è ' + c.email + '</a></div>' : ''}
                                    ${c.phone ? '<div style="font-size: 12px; margin: 3px 0;"><a href="tel:' + c.phone + '" style="color: #2563eb; text-decoration: none;">üìû ' + c.phone + '</a></div>' : ''}
                                    ${c.category ? '<div style="font-size: 11px; color: #6b7280; margin-top: 6px; padding-top: 6px; border-top: 1px solid #e5e7eb;">' + c.category + '</div>' : ''}
                                </div>
                            `);
                            
                            markerClusterGroup.addLayer(marker);
                        }
                        
                        loaded++;
                        document.getElementById('progressText').textContent = `${loaded} / ${list.length}`;
                        document.getElementById('progressFill').style.width = `${(loaded / list.length) * 100}%`;
                    } catch(e) {
                        loaded++;
                        document.getElementById('progressText').textContent = `${loaded} / ${list.length}`;
                        document.getElementById('progressFill').style.width = `${(loaded / list.length) * 100}%`;
                    }
                }));

                await new Promise(r => setTimeout(r, 250));
            }

            setTimeout(() => {
                if (progressDiv.parentNode) progressDiv.remove();
                isGeocoding = false;
            }, 2000);
        }

        document.getElementById('provinceFilter').addEventListener('change', function(e) {
            const province = e.target.value;
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = customers;
            if (province) filtered = filtered.filter(c => c.province === province);
            if (search) filtered = filtered.filter(c => 
                c.name.toLowerCase().includes(search) || 
                c.city.toLowerCase().includes(search) ||
                c.category.toLowerCase().includes(search)
            );
            
            showCustomers(filtered);
            updateStats(filtered);
            
            if (province && filtered.length > 0) {
                document.getElementById('infoBox').innerHTML = `
                    <div class="info-box">
                        <div class="info-title">üîÑ Caricamento ${filtered.length} marker...</div>
                        I marker vengono raggruppati automaticamente. Fai zoom per vedere i dettagli!
                    </div>
                `;
                geocodeAll(filtered);
            } else if (province) {
                markerClusterGroup.clearLayers();
            }
        });

        document.getElementById('searchInput').addEventListener('input', function(e) {
            const search = e.target.value.toLowerCase();
            const province = document.getElementById('provinceFilter').value;
            
            let filtered = customers;
            if (province) filtered = filtered.filter(c => c.province === province);
            if (search) filtered = filtered.filter(c => 
                c.name.toLowerCase().includes(search) || 
                c.city.toLowerCase().includes(search) ||
                c.category.toLowerCase().includes(search)
            );
            
            showCustomers(filtered);
            updateStats(filtered);
        });
    </script>
</body>
</html>
