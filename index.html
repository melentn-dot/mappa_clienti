<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa Clienti</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; }
        .sidebar { width: 350px; background: white; box-shadow: 2px 0 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .header { background: #2563eb; color: white; padding: 20px; }
        .upload-area { padding: 20px; text-align: center; }
        .upload-btn { background: #2563eb; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .upload-btn:hover { background: #1d4ed8; }
        .filters { padding: 20px; border-top: 1px solid #e5e7eb; display: none; }
        .filters.active { display: block; }
        .filters select, .filters input { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #d1d5db; border-radius: 4px; box-sizing: border-box; }
        .customer-list { flex: 1; overflow-y: auto; padding: 10px; }
        .customer-card { background: #f9fafb; padding: 10px; margin-bottom: 8px; border-radius: 6px; font-size: 13px; }
        .customer-card.secondary { background: #fff7ed; }
        .customer-name { font-weight: bold; margin-bottom: 4px; }
        #map { flex: 1; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="header">
            <h2>üèóÔ∏è Mappa Clienti</h2>
        </div>
        <div class="upload-area">
            <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">üìÅ Carica Excel</button>
        </div>
        <div class="filters" id="filters">
            <select id="provinceFilter"><option value="">Tutte le province</option></select>
            <input type="text" id="searchInput" placeholder="Cerca cliente...">
        </div>
        <div class="customer-list" id="customerList"></div>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let map = L.map('map').setView([45.4642, 9.19], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let customers = [], markers = [];

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                processData(rows);
            };
            reader.readAsArrayBuffer(file);
        });

        function processData(rows) {
            customers = [];
            const provinces = new Set();
            rows.forEach(row => {
                if (row['Indirizzo'] && row['Localita']) {
                    const prov = (row['Localita'].match(/\(([A-Z]{2})\)/) || [])[1] || '';
                    if (prov) provinces.add(prov);
                    customers.push({
                        name: row['Nome Cliente'],
                        address: row['Indirizzo'] + ', ' + row['Localita'] + ', Italy',
                        email: row['Email'] || '',
                        phone: row['Telefono'] || '',
                        city: row['Localita'],
                        province: prov,
                        type: 'primary'
                    });
                }
                if (row['Indirizzo Secondario di consegna'] && row['Localita Indirizzo Secondario di consegna']) {
                    const prov = (row['Localita Indirizzo Secondario di consegna'].match(/\(([A-Z]{2})\)/) || [])[1] || '';
                    if (prov) provinces.add(prov);
                    customers.push({
                        name: row['Nome Cliente'],
                        address: row['Indirizzo Secondario di consegna'] + ', ' + row['Localita Indirizzo Secondario di consegna'] + ', Italy',
                        email: row['Email'] || '',
                        phone: row['Telefono'] || '',
                        city: row['Localita Indirizzo Secondario di consegna'],
                        province: prov,
                        type: 'secondary'
                    });
                }
            });
            const select = document.getElementById('provinceFilter');
            Array.from(provinces).sort().forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.textContent = p + ' (' + customers.filter(c => c.province === p).length + ')';
                select.appendChild(opt);
            });
            document.getElementById('filters').classList.add('active');
            showCustomers(customers);
            if (customers.length <= 50) geocodeAll(customers);
        }

        function showCustomers(list) {
            document.getElementById('customerList').innerHTML = list.slice(0, 100).map(c => `
                <div class="customer-card ${c.type}">
                    <div class="customer-name">${c.name}</div>
                    <div>${c.city}</div>
                    ${c.email ? '<div>‚úâÔ∏è ' + c.email + '</div>' : ''}
                    ${c.phone ? '<div>üìû ' + c.phone + '</div>' : ''}
                </div>
            `).join('');
        }

        async function geocodeAll(list) {
            markers.forEach(m => m.remove());
            markers = [];
            for (const c of list) {
                try {
                    const res = await fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(c.address) + '&limit=1');
                    const data = await res.json();
                    if (data[0]) {
                        const marker = L.marker([data[0].lat, data[0].lon], {
                            icon: L.divIcon({
                                html: '<div style="background:' + (c.type === 'primary' ? '#2563eb' : '#f97316') + ';width:12px;height:12px;border-radius:50%;border:2px solid white"></div>',
                                iconSize: [12, 12],
                                iconAnchor: [6, 6]
                            })
                        }).addTo(map);
                        marker.bindPopup('<b>' + c.name + '</b><br>' + c.city);
                        markers.push(marker);
                    }
                    await new Promise(r => setTimeout(r, 1100));
                } catch(e) {}
            }
        }

        document.getElementById('provinceFilter').addEventListener('change', function(e) {
            const filtered = e.target.value ? customers.filter(c => c.province === e.target.value) : customers;
            showCustomers(filtered);
            if (e.target.value && filtered.length <= 50) geocodeAll(filtered);
        });

        document.getElementById('searchInput').addEventListener('input', function(e) {
            const search = e.target.value.toLowerCase();
            showCustomers(customers.filter(c => c.name.toLowerCase().includes(search) || c.city.toLowerCase().includes(search)));
        });
    </script>
</body>
</html>
